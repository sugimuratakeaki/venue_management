import React, { useState } from 'react';
import styled from 'styled-components';
import { Card, Text, Badge, Button } from '../../atoms';
import { InfoItem } from '../../molecules';
import { theme } from '../../../styles/theme';

export interface VenueDetailProps {
  venue: any;
  onBack?: () => void;
  onEdit?: () => void;
}

const Container = styled.div`
  max-width: 1200px;
  margin: 0 auto;
`;

const BackButton = styled(Button)`
  margin-bottom: ${theme.spacing.lg};
`;

const MainCard = styled(Card)`
  margin-bottom: ${theme.spacing.lg};
`;

const Header = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: ${theme.spacing.lg};
  padding-bottom: ${theme.spacing.md};
  border-bottom: 2px solid ${theme.colors.neutral[200]};
`;

const TitleSection = styled.div`
  flex: 1;
`;

const StatusBadge = styled(Badge)`
  margin-top: ${theme.spacing.xs};
`;

const TabContainer = styled.div`
  display: flex;
  gap: ${theme.spacing.xs};
  margin-bottom: ${theme.spacing.xl};
  border-bottom: 2px solid ${theme.colors.neutral[200]};
  overflow-x: auto;
`;

const Tab = styled.button<{ active?: boolean }>`
  padding: ${theme.spacing.md} ${theme.spacing.lg};
  background: none;
  border: none;
  border-bottom: 3px solid ${props => props.active ? theme.colors.primary[500] : 'transparent'};
  color: ${props => props.active ? theme.colors.primary[700] : theme.colors.neutral[600]};
  font-weight: ${props => props.active ? theme.fontWeight.semibold : theme.fontWeight.regular};
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  
  &:hover {
    color: ${theme.colors.primary[600]};
  }
`;

const Section = styled.div`
  margin-bottom: ${theme.spacing.xl};
  
  &:last-child {
    margin-bottom: 0;
  }
`;

const SectionTitle = styled(Text)`
  margin-bottom: ${theme.spacing.md};
  padding-bottom: ${theme.spacing.sm};
  border-bottom: 1px solid ${theme.colors.neutral[200]};
`;

const InfoGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: ${theme.spacing.md};
`;

const InfoCard = styled(Card)`
  background-color: ${theme.colors.neutral[50]};
`;

const RoomsGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: ${theme.spacing.lg};
`;

const RoomCard = styled(Card)`
  background-color: ${theme.colors.neutral[50]};
`;

const RoomHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: ${theme.spacing.md};
  padding-bottom: ${theme.spacing.sm};
  border-bottom: 1px solid ${theme.colors.neutral[200]};
`;

const RoomSpecs = styled.div`
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: ${theme.spacing.sm};
  margin: ${theme.spacing.md} 0;
`;

const SpecItem = styled.div`
  display: flex;
  justify-content: space-between;
  padding: ${theme.spacing.xs} 0;
  border-bottom: 1px solid ${theme.colors.neutral[100]};
`;

const ControlRoomList = styled.div`
  margin-top: ${theme.spacing.md};
  padding: ${theme.spacing.sm};
  background: ${theme.colors.neutral[0]};
  border-radius: ${theme.borderRadius.sm};
`;

const StationsGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: ${theme.spacing.md};
`;

const EquipmentGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: ${theme.spacing.sm};
`;

const EquipmentItem = styled.div<{ available?: boolean }>`
  display: flex;
  align-items: center;
  gap: ${theme.spacing.xs};
  padding: ${theme.spacing.sm};
  background: ${props => props.available ? theme.colors.success + '10' : theme.colors.neutral[50]};
  border-radius: ${theme.borderRadius.sm};
  color: ${props => props.available ? theme.colors.neutral[700] : theme.colors.neutral[400]};
`;

const CheckIcon = styled.span`
  color: ${theme.colors.success};
  font-weight: ${theme.fontWeight.bold};
`;

const CrossIcon = styled.span`
  color: ${theme.colors.neutral[400]};
`;

const PricingTable = styled.table`
  width: 100%;
  border-collapse: collapse;
`;

const PricingRow = styled.tr`
  border-bottom: 1px solid ${theme.colors.neutral[200]};
  
  &:last-child {
    border-bottom: none;
  }
`;

const PricingLabel = styled.td`
  padding: ${theme.spacing.sm} ${theme.spacing.md};
  font-weight: ${theme.fontWeight.medium};
  color: ${theme.colors.neutral[600]};
  width: 40%;
`;

const PricingValue = styled.td`
  padding: ${theme.spacing.sm} ${theme.spacing.md};
  color: ${theme.colors.neutral[700]};
`;

const MapContainer = styled.div`
  margin-top: ${theme.spacing.md};
  border-radius: ${theme.borderRadius.md};
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  height: 400px;
  background: ${theme.colors.neutral[100]};
`;

const ActionButtons = styled.div`
  display: flex;
  gap: ${theme.spacing.md};
  margin-top: ${theme.spacing.xl};
  
  @media (max-width: ${theme.breakpoints.mobile}) {
    flex-direction: column;
  }
`;

// Ë®≠ÂÇô„Çø„Ç§„Éó„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàÂÆüÈöõ„ÅØAPI„Åã„ÇâÂèñÂæóÔºâ
const FACILITY_TYPES: { [key: number]: string } = {
  1: '„Çπ„ÇØ„É™„Éº„É≥',
  2: '„Éó„É≠„Ç∏„Çß„ÇØ„Çø„Éº',
  3: '„ÉØ„Ç§„É§„É¨„Çπ„Éû„Ç§„ÇØ',
  4: 'ÊúâÁ∑ö„Éû„Ç§„ÇØ',
  5: '„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ',
  6: 'ÊºîÂè∞'
};

export const VenueDetail: React.FC<VenueDetailProps> = ({ venue, onBack, onEdit }) => {
  const [activeTab, setActiveTab] = useState('basic');
  
  if (!venue) return null;

  // Extract place ID or coordinates from Google Maps URL
  const getMapEmbedUrl = (googleMapUrl: string) => {
    if (!googleMapUrl) return null;
    
    // If it's already an embed URL, return it
    if (googleMapUrl.includes('embed')) return googleMapUrl;
    
    // Extract query parameter for search
    const match = googleMapUrl.match(/[?&]q=([^&]+)/);
    if (match) {
      const query = match[1];
      return `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${query}`;
    }
    
    // If it's a place URL, extract place name
    const placeMatch = googleMapUrl.match(/place\/([^/]+)/);
    if (placeMatch) {
      const place = placeMatch[1];
      return `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${place}`;
    }
    
    // Default: use the address for search
    return `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(venue.address)}`;
  };

  const mapEmbedUrl = getMapEmbedUrl(venue.google_map_url);

  const tabs = [
    { id: 'basic', label: 'Âü∫Êú¨ÊÉÖÂ†±' },
    { id: 'rooms', label: 'ÈÉ®Â±ã„ÉªË®≠ÂÇô' },
    { id: 'pricing', label: 'ÊñôÈáë' },
    { id: 'access', label: '„Ç¢„ÇØ„Çª„Çπ„ÉªÈßêËªäÂ†¥' },
    { id: 'conditions', label: 'Âà©Áî®Êù°‰ª∂' },
  ];

  return (
    <Container>
      {onBack && (
        <BackButton variant="text" onClick={onBack}>
          ‚Üê ‰∏ÄË¶ß„Å´Êàª„Çã
        </BackButton>
      )}

      <MainCard padding="large">
        <Header>
          <TitleSection>
            <Text as="h1" size="xxl" weight="bold">
              {venue.venue_name}
            </Text>
            <Text size="sm" color={theme.colors.neutral[500]}>
              ‰ºöÂ†¥Áï™Âè∑: {venue.venue_no}
            </Text>
          </TitleSection>
          <StatusBadge variant={venue.is_active ? 'success' : 'neutral'}>
            {venue.is_active ? 'Âà©Áî®ÂèØËÉΩ' : 'Á¢∫Ë™ç‰∏≠'}
          </StatusBadge>
        </Header>

        <TabContainer>
          {tabs.map(tab => (
            <Tab
              key={tab.id}
              active={activeTab === tab.id}
              onClick={() => setActiveTab(tab.id)}
            >
              {tab.label}
            </Tab>
          ))}
        </TabContainer>

        {activeTab === 'basic' && (
          <>
            <Section>
              <SectionTitle as="h2" size="lg" weight="semibold">
                ÈÄ£Áµ°ÂÖàÊÉÖÂ†±
              </SectionTitle>
              <InfoGrid>
                <InfoItem
                  label="‰ΩèÊâÄ"
                  value={`„Äí${venue.postal_code || ''} ${venue.address}`}
                  icon="üìç"
                />
                {venue.google_map_url && mapEmbedUrl && (
                  <MapContainer style={{gridColumn: 'span 2'}}>
                    <iframe
                      width="100%"
                      height="100%"
                      frameBorder="0"
                      style={{ border: 0 }}
                      src={mapEmbedUrl}
                      allowFullScreen
                      loading="lazy"
                      referrerPolicy="no-referrer-when-downgrade"
                    />
                  </MapContainer>
                )}
                <InfoItem
                  label="ÈõªË©±Áï™Âè∑"
                  value={venue.phone_number || 'Êú™ÁôªÈå≤'}
                  icon="üìû"
                />
                {venue.email && (
                  <InfoItem
                    label="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ"
                    value={venue.email}
                    icon="‚úâÔ∏è"
                  />
                )}
                {venue.contact_person && (
                  <InfoItem
                    label="ÊãÖÂΩìËÄÖ"
                    value={venue.contact_person}
                    icon="üë§"
                  />
                )}
                {venue.official_url && (
                  <InfoItem
                    label="ÂÖ¨Âºè„Çµ„Ç§„Éà"
                    value={
                      <a href={venue.official_url} target="_blank" rel="noopener noreferrer">
                        {venue.official_url}
                      </a>
                    }
                    icon="üåê"
                  />
                )}
                {venue.reservation_url && (
                  <InfoItem
                    label="‰∫àÁ¥Ñ„Çµ„Ç§„Éà"
                    value={
                      <a href={venue.reservation_url} target="_blank" rel="noopener noreferrer">
                        {venue.reservation_url}
                      </a>
                    }
                    icon="üìÖ"
                  />
                )}
              </InfoGrid>
            </Section>

            <Section>
              <SectionTitle as="h2" size="lg" weight="semibold">
                Âñ∂Ê•≠ÊÉÖÂ†±
              </SectionTitle>
              <InfoGrid>
                {venue.operating_hours && (
                  <InfoItem
                    label="Âñ∂Ê•≠ÊôÇÈñì"
                    value={venue.operating_hours}
                    icon="üïê"
                  />
                )}
                <InfoItem
                  label="Ëç∑Áâ©ÂèóÂèñ"
                  value={venue.can_receive_package ? 'ÂèØËÉΩ' : '‰∏çÂèØ'}
                  icon="üì¶"
                />
                {venue.package_receiver && (
                  <InfoItem
                    label="Ëç∑Áâ©ÂèóÂèñËÄÖ/Â†¥ÊâÄ"
                    value={venue.package_receiver}
                    icon="üë•"
                  />
                )}
              </InfoGrid>
            </Section>

            {venue.notes && (
              <Section>
                <SectionTitle as="h2" size="lg" weight="semibold">
                  ÂÇôËÄÉ
                </SectionTitle>
                <Text>{venue.notes}</Text>
              </Section>
            )}
          </>
        )}

        {activeTab === 'rooms' && (
          <>
            {venue.rooms && venue.rooms.length > 0 && (
              <Section>
                <SectionTitle as="h2" size="lg" weight="semibold">
                  ÈÉ®Â±ãÊÉÖÂ†±
                </SectionTitle>
                <RoomsGrid>
                  {venue.rooms.map((room: any, index: number) => (
                    <RoomCard key={index} padding="medium">
                      <RoomHeader>
                        <div>
                          <Text size="lg" weight="semibold">{room.room_name}</Text>
                          {room.is_main_room && (
                            <Badge variant="primary" size="small">„É°„Ç§„É≥‰ºöÂ†¥</Badge>
                          )}
                        </div>
                      </RoomHeader>
                      
                      <RoomSpecs>
                        {room.ceiling_height && (
                          <SpecItem>
                            <Text size="sm" color={theme.colors.neutral[600]}>Â§©‰∫ïÈ´ò</Text>
                            <Text size="sm" weight="medium">{room.ceiling_height}m</Text>
                          </SpecItem>
                        )}
                        {room.floor_area && (
                          <SpecItem>
                            <Text size="sm" color={theme.colors.neutral[600]}>Èù¢Á©ç</Text>
                            <Text size="sm" weight="medium">{room.floor_area}„é°</Text>
                          </SpecItem>
                        )}
                        {room.capacity && (
                          <SpecItem>
                            <Text size="sm" color={theme.colors.neutral[600]}>ÂèéÂÆπ‰∫∫Êï∞</Text>
                            <Text size="sm" weight="medium">{room.capacity}Âêç</Text>
                          </SpecItem>
                        )}
                        {room.desk_count && (
                          <SpecItem>
                            <Text size="sm" color={theme.colors.neutral[600]}>Êú∫</Text>
                            <Text size="sm" weight="medium">{room.desk_count}Âè∞</Text>
                          </SpecItem>
                        )}
                        {room.chair_count && (
                          <SpecItem>
                            <Text size="sm" color={theme.colors.neutral[600]}>Ê§ÖÂ≠ê</Text>
                            <Text size="sm" weight="medium">{room.chair_count}ËÑö</Text>
                          </SpecItem>
                        )}
                      </RoomSpecs>
                      
                      {room.control_rooms && room.control_rooms.length > 0 && (
                        <ControlRoomList>
                          <Text size="sm" weight="semibold" style={{ marginBottom: theme.spacing.xs }}>
                            ÊéßÂÆ§
                          </Text>
                          {room.control_rooms.map((control: any, cIndex: number) => (
                            <div key={cIndex} style={{ marginBottom: theme.spacing.xs }}>
                              <Text size="xs" weight="medium">
                                {control.control_room_name}
                              </Text>
                              <Text size="xs" color={theme.colors.neutral[600]}>
                                {control.control_room_area}„é° / {control.capacity}Âêç / Êú∫{control.desk_count} / Ê§ÖÂ≠ê{control.chair_count}
                              </Text>
                              {control.notes && (
                                <Text size="xs" color={theme.colors.neutral[500]}>
                                  {control.notes}
                                </Text>
                              )}
                            </div>
                          ))}
                        </ControlRoomList>
                      )}
                    </RoomCard>
                  ))}
                </RoomsGrid>
              </Section>
            )}

            {venue.facilities && venue.facilities.length > 0 && (
              <Section>
                <SectionTitle as="h2" size="lg" weight="semibold">
                  Ë®≠ÂÇô
                </SectionTitle>
                <EquipmentGrid>
                  {venue.facilities.map((facility: any, index: number) => (
                    <EquipmentItem key={index} available={facility.quantity > 0}>
                      {facility.quantity > 0 ? <CheckIcon>‚úì</CheckIcon> : <CrossIcon>‚úó</CrossIcon>}
                      {FACILITY_TYPES[facility.facility_type_id] || `Ë®≠ÂÇô${facility.facility_type_id}`}
                      {facility.quantity > 1 && ` (${facility.quantity})`}
                      {facility.is_wireless !== undefined && facility.is_wireless && ' („ÉØ„Ç§„É§„É¨„Çπ)'}
                      {facility.notes && ` - ${facility.notes}`}
                    </EquipmentItem>
                  ))}
                </EquipmentGrid>
              </Section>
            )}

            <Section>
              <SectionTitle as="h2" size="lg" weight="semibold">
                Âà©Áî®ÂèØËÉΩÊù°‰ª∂
              </SectionTitle>
              <EquipmentGrid>
                <EquipmentItem available={venue.can_eat_drink}>
                  {venue.can_eat_drink ? <CheckIcon>‚úì</CheckIcon> : <CrossIcon>‚úó</CrossIcon>}
                  È£≤È£üÂèØ
                </EquipmentItem>
                <EquipmentItem available={venue.can_wear_shoes}>
                  {venue.can_wear_shoes ? <CheckIcon>‚úì</CheckIcon> : <CrossIcon>‚úó</CrossIcon>}
                  ÂúüË∂≥ÂèØ
                </EquipmentItem>
                <EquipmentItem available={venue.is_earthquake_resistant}>
                  {venue.is_earthquake_resistant ? <CheckIcon>‚úì</CheckIcon> : <CrossIcon>‚úó</CrossIcon>}
                  ËÄêÈúáÂü∫Ê∫ñÈÅ©Âêà
                </EquipmentItem>
              </EquipmentGrid>
            </Section>
          </>
        )}

        {activeTab === 'pricing' && venue.fees && (
          <Section>
            <SectionTitle as="h2" size="lg" weight="semibold">
              ÊñôÈáëÊÉÖÂ†±Ôºà2.5-3Êó•ÈñìÔºâ
            </SectionTitle>
            <InfoCard padding="medium">
              <PricingTable>
                <tbody>
                  {venue.fees.main_venue_fee && (
                    <PricingRow>
                      <PricingLabel>„É°„Ç§„É≥‰ºöÂ†¥Ë≤ªÁî®</PricingLabel>
                      <PricingValue>
                        <Text size="lg" weight="semibold" color={theme.colors.primary[600]}>
                          ¬•{venue.fees.main_venue_fee.toLocaleString()}
                        </Text>
                      </PricingValue>
                    </PricingRow>
                  )}
                  {venue.fees.control_room_fee && (
                    <PricingRow>
                      <PricingLabel>ÊéßÂÆ§Ë≤ªÁî®</PricingLabel>
                      <PricingValue>¬•{venue.fees.control_room_fee.toLocaleString()}</PricingValue>
                    </PricingRow>
                  )}
                  {venue.fees.equipment_fee && (
                    <PricingRow>
                      <PricingLabel>ÂÇôÂìÅË≤ªÁî®</PricingLabel>
                      <PricingValue>¬•{venue.fees.equipment_fee.toLocaleString()}</PricingValue>
                    </PricingRow>
                  )}
                  {venue.fees.electricity_fee && (
                    <PricingRow>
                      <PricingLabel>ÈõªÊ∞ó‰ª£</PricingLabel>
                      <PricingValue>¬•{venue.fees.electricity_fee.toLocaleString()}</PricingValue>
                    </PricingRow>
                  )}
                  {venue.fees.air_conditioner_fee && (
                    <PricingRow>
                      <PricingLabel>„Ç®„Ç¢„Ç≥„É≥‰ª£</PricingLabel>
                      <PricingValue>¬•{venue.fees.air_conditioner_fee.toLocaleString()}</PricingValue>
                    </PricingRow>
                  )}
                  {venue.fees.notes && (
                    <PricingRow>
                      <PricingLabel>ÂÇôËÄÉ</PricingLabel>
                      <PricingValue>{venue.fees.notes}</PricingValue>
                    </PricingRow>
                  )}
                </tbody>
              </PricingTable>
            </InfoCard>
          </Section>
        )}

        {activeTab === 'access' && (
          <>
            {venue.stations && venue.stations.length > 0 && (
              <Section>
                <SectionTitle as="h2" size="lg" weight="semibold">
                  ÊúÄÂØÑ„ÇäÈßÖ
                </SectionTitle>
                <StationsGrid>
                  {venue.stations.map((station: any, index: number) => (
                    <InfoCard key={index} padding="medium">
                      <Text weight="semibold">{station.station_name}</Text>
                      <Text size="sm" color={theme.colors.neutral[600]}>
                        {station.line_name}
                      </Text>
                      {station.transport_method && (
                        <Text size="sm">
                          {station.transport_method}
                          {station.travel_time && ` ${station.travel_time}ÂàÜ`}
                        </Text>
                      )}
                      {station.notes && (
                        <Text size="sm" color={theme.colors.neutral[500]}>
                          {station.notes}
                        </Text>
                      )}
                    </InfoCard>
                  ))}
                </StationsGrid>
              </Section>
            )}

            {venue.parking && (
              <Section>
                <SectionTitle as="h2" size="lg" weight="semibold">
                  ÈßêËªäÂ†¥ÊÉÖÂ†±
                </SectionTitle>
                <InfoGrid>
                  {venue.parking.parking_capacity && (
                    <InfoItem
                      label="ÂèéÂÆπÂè∞Êï∞"
                      value={`${venue.parking.parking_capacity}Âè∞`}
                      icon="üöó"
                    />
                  )}
                  <InfoItem
                    label="ÊñôÈáë"
                    value={venue.parking.is_free ? 'ÁÑ°Êñô' : venue.parking.parking_fee}
                    icon="üí∞"
                  />
                  {venue.parking.nearby_parking_info && (
                    <InfoItem
                      label="Âë®Ëæ∫ÈßêËªäÂ†¥"
                      value={venue.parking.nearby_parking_info}
                      icon="üÖøÔ∏è"
                    />
                  )}
                </InfoGrid>
              </Section>
            )}
          </>
        )}

        {activeTab === 'conditions' && venue.conditions && (
          <Section>
            <SectionTitle as="h2" size="lg" weight="semibold">
              ‰∫àÁ¥Ñ„ÉªÂà©Áî®Êù°‰ª∂
            </SectionTitle>
            <InfoGrid>
              {venue.conditions.reservation_conditions && (
                <InfoItem
                  label="‰∫àÁ¥ÑÊù°‰ª∂"
                  value={venue.conditions.reservation_conditions}
                  icon="üìã"
                />
              )}
              {venue.conditions.cancellation_policy && (
                <InfoItem
                  label="„Ç≠„É£„É≥„Çª„É´„Éù„É™„Ç∑„Éº"
                  value={venue.conditions.cancellation_policy}
                  icon="‚ö†Ô∏è"
                />
              )}
              {venue.conditions.payment_terms && (
                <InfoItem
                  label="ÊîØÊâïÊù°‰ª∂"
                  value={venue.conditions.payment_terms}
                  icon="üí≥"
                />
              )}
              {venue.conditions.advance_reservation_days && (
                <InfoItem
                  label="‰∫àÁ¥ÑÂèØËÉΩÊúüÈñì"
                  value={`${venue.conditions.advance_reservation_days}Êó•Ââç„Åã„Çâ`}
                  icon="üìÖ"
                />
              )}
              {venue.conditions.cancellation_deadline_days && (
                <InfoItem
                  label="„Ç≠„É£„É≥„Çª„É´ÊúüÈôê"
                  value={`Âà©Áî®Êó•„ÅÆ${venue.conditions.cancellation_deadline_days}Êó•Ââç„Åæ„Åß`}
                  icon="üïê"
                />
              )}
            </InfoGrid>
          </Section>
        )}

        <ActionButtons>
          <Button variant="primary" fullWidth onClick={onEdit}>
            Á∑®ÈõÜ„Åô„Çã
          </Button>
          <Button variant="outline" fullWidth>
            PDF„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà
          </Button>
          <Button variant="outline" fullWidth>
            Âç∞Âà∑„Åô„Çã
          </Button>
        </ActionButtons>
      </MainCard>
    </Container>
  );
};