# 防災士研修センター会場管理システム システムアーキテクチャ設計書

## 1. 概要

### 1.1 目的
本書は、防災士研修センター会場管理システムのシステムアーキテクチャを定義し、技術的な設計方針と実装指針を明確にすることを目的とする。

### 1.2 スコープ
- システム全体のアーキテクチャ設計
- 技術コンポーネントの選定理由
- フェーズごとの実装方針
- スケーラビリティと拡張性の考慮

### 1.3 対象読者
- システムアーキテクト
- 開発エンジニア
- プロジェクトマネージャー
- インフラエンジニア

## 2. アーキテクチャ概要

### 2.1 アーキテクチャパターン
**3層アーキテクチャ + マイクロサービス指向**

```
┌─────────────────────────────────────────────────┐
│                  クライアント層                   │
│              (React + Atomic Design)             │
└─────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────┐
│                アプリケーション層                  │
│                (FastAPI + Python)                │
└─────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────┐
│                   データ層                        │
│         (JSON → SQLite → PostgreSQL)            │
└─────────────────────────────────────────────────┘
```

### 2.2 設計原則
1. **段階的実装**: フェーズごとに機能とインフラを拡張
2. **疎結合**: フロントエンドとバックエンドの独立性を保持
3. **RESTful API**: 標準的なWeb APIの設計規約に準拠
4. **コンポーネント指向**: Atomic Designによる再利用可能なUI部品
5. **セキュリティファースト**: 認証・認可の適切な実装

## 3. フェーズ別アーキテクチャ

### 3.1 フェーズ1: プロトタイプ開発

#### 構成
```
┌──────────────────┐
│  React Frontend  │
│  (開発サーバー)   │
└────────┬─────────┘
         │
    JSONファイル
    (/data/*.json)
```

#### 特徴
- **データストア**: JSONファイル
- **API**: 疑似API（JSONファイル読み込み）
- **認証**: ローカルストレージベース（簡易実装）
- **環境**: ローカル開発環境

#### 目的
- UIデザインの検証
- ユーザビリティテスト
- 基本機能の動作確認

### 3.2 フェーズ2: バックエンド実装

#### 構成
```
┌──────────────────┐     ┌──────────────────┐
│  React Frontend  │────▶│  FastAPI Backend │
└──────────────────┘     └────────┬─────────┘
                                   │
                            ┌──────▼──────┐
                            │   SQLite    │
                            └─────────────┘
```

#### 特徴
- **データベース**: SQLite（ファイルベース）
- **API**: RESTful API（FastAPI）
- **認証**: JWT認証
- **環境**: 開発・テスト環境

#### 実装内容
- CRUD操作の実装
- API認証・認可
- データバリデーション
- エラーハンドリング

### 3.3 フェーズ3: 本番環境構築

#### 構成
```
         Replit Platform
┌────────────────────────────┐
│     Nginx (Reverse Proxy)  │
└──────────┬─────────────────┘
           │
    ┌──────▼──────┐     ┌──────────────┐
    │   React     │────▶│   FastAPI    │
    │  (Static)   │     │  (Uvicorn)   │
    └─────────────┘     └──────┬───────┘
                               │
                        ┌──────▼──────┐
                        │ PostgreSQL  │
                        └─────────────┘
```

#### 特徴
- **データベース**: PostgreSQL（Replit Database）
- **ホスティング**: Replit
- **認証**: 本格的な認証システム
- **監視**: Replit標準監視

## 4. コンポーネント設計

### 4.1 フロントエンド

#### 技術スタック
- **フレームワーク**: React 18.x
- **状態管理**: React Context API / Redux Toolkit
- **ルーティング**: React Router v6
- **UIフレームワーク**: カスタムAtomic Design
- **スタイリング**: CSS Modules / Styled Components
- **ビルドツール**: Vite
- **型チェック**: TypeScript（オプション）

#### ディレクトリ構成
```
frontend/
├── src/
│   ├── components/
│   │   ├── atoms/        # 最小単位のUI部品
│   │   ├── molecules/    # 複合UI部品
│   │   ├── organisms/    # 複雑なUI部品
│   │   ├── templates/    # ページレイアウト
│   │   └── pages/        # ページコンポーネント
│   ├── hooks/            # カスタムフック
│   ├── services/         # API通信
│   ├── utils/            # ユーティリティ
│   ├── contexts/         # Contextプロバイダー
│   └── styles/           # グローバルスタイル
└── public/               # 静的ファイル
```

### 4.2 バックエンド

#### 技術スタック
- **言語**: Python 3.9+
- **フレームワーク**: FastAPI
- **ASGI サーバー**: Uvicorn
- **ORM**: SQLAlchemy
- **マイグレーション**: Alembic
- **バリデーション**: Pydantic
- **認証**: python-jose (JWT)

#### ディレクトリ構成
```
backend/
├── app/
│   ├── api/
│   │   ├── endpoints/    # APIエンドポイント
│   │   └── deps.py       # 依存関係
│   ├── core/
│   │   ├── config.py     # 設定
│   │   └── security.py   # セキュリティ
│   ├── crud/             # CRUD操作
│   ├── db/
│   │   ├── base.py       # DB基本設定
│   │   └── session.py    # セッション管理
│   ├── models/           # SQLAlchemyモデル
│   ├── schemas/          # Pydanticスキーマ
│   └── main.py           # アプリケーションエントリー
├── alembic/              # DBマイグレーション
└── tests/                # テスト
```

### 4.3 データベース

#### フェーズ別構成

##### フェーズ1: JSON
```json
{
  "venues": [
    {
      "id": 1,
      "name": "会場名",
      "address": "住所",
      "rooms": [],
      "stations": []
    }
  ]
}
```

##### フェーズ2: SQLite
- 単一ファイルデータベース
- 開発環境での高速動作
- トランザクション対応

##### フェーズ3: PostgreSQL
- Replit Database統合
- 本番環境対応
- バックアップ・リストア機能

## 5. API設計

### 5.1 設計原則
- RESTful設計
- OpenAPI 3.0準拠
- バージョニング対応
- ページネーション実装
- エラーレスポンス標準化

### 5.2 エンドポイント構成
```
/api/v1/
├── /auth
│   ├── POST /login
│   ├── POST /logout
│   └── POST /refresh
├── /venues
│   ├── GET /
│   ├── POST /
│   ├── GET /{id}
│   ├── PUT /{id}
│   └── DELETE /{id}
├── /rooms
│   ├── GET /venue/{venue_id}
│   └── POST /venue/{venue_id}
├── /ai
│   └── POST /analyze
└── /users
    ├── GET /
    └── POST /
```

## 6. セキュリティアーキテクチャ

### 6.1 認証・認可

#### 認証フロー
```
1. ユーザーログイン
2. 認証情報検証
3. JWTトークン発行
4. トークンベース認証
5. リフレッシュトークン対応
```

#### 権限管理
- **ロールベースアクセス制御（RBAC）**
  - システム管理者
  - 運営管理者
  - 一般利用者

### 6.2 セキュリティ対策
- **通信**: HTTPS必須
- **パスワード**: bcryptハッシュ化
- **API**: レート制限
- **CORS**: 適切な設定
- **入力検証**: SQLインジェクション対策
- **XSS対策**: サニタイゼーション

## 7. 外部サービス連携

### 7.1 OpenAI API
```python
# 連携方式
client = OpenAI(api_key=settings.OPENAI_API_KEY)
response = client.chat.completions.create(
    model="gpt-4",
    messages=[{"role": "user", "content": text}]
)
```

### 7.2 Google Maps API
- 住所からの座標取得
- マップURL生成
- 経路検索（将来実装）

### 7.3 メールサービス
- SendGrid（本番）
- SMTP（開発）

## 8. デプロイメントアーキテクチャ

### 8.1 Replit構成
```yaml
# .replit
run = "npm run dev"
[env]
  PYTHONPATH = "/home/runner/${REPL_SLUG}"
[packager]
  language = "python3"
```

### 8.2 環境変数管理
```
# 開発環境
.env.development

# 本番環境
Replit Secrets
```

### 8.3 CI/CD
- GitHub Actions
- 自動テスト
- 自動デプロイ

## 9. パフォーマンス設計

### 9.1 フロントエンド最適化
- コード分割（Code Splitting）
- 遅延読み込み（Lazy Loading）
- 画像最適化
- キャッシュ戦略

### 9.2 バックエンド最適化
- 非同期処理（async/await）
- データベースインデックス
- クエリ最適化
- レスポンスキャッシュ

### 9.3 スケーリング戦略
- 垂直スケーリング（Replit プラン変更）
- 水平スケーリング（AWS移行時）
- CDN活用（静的ファイル）

## 10. 監視・運用

### 10.1 監視項目
- アプリケーションログ
- エラー率
- レスポンスタイム
- リソース使用率

### 10.2 ログ設計
```python
# ログレベル
DEBUG: 開発環境のみ
INFO: 通常操作
WARNING: 警告
ERROR: エラー
CRITICAL: 致命的エラー
```

## 11. 災害復旧計画

### 11.1 バックアップ
- **頻度**: 日次
- **保持期間**: 30日
- **方式**: PostgreSQLダンプ

### 11.2 復旧手順
1. バックアップからのリストア
2. アプリケーション再デプロイ
3. 動作確認
4. サービス再開

## 12. 将来の拡張性

### 12.1 AWS移行計画
```
Replit → AWS
- EC2: アプリケーションサーバー
- RDS: PostgreSQL
- S3: 静的ファイル
- CloudFront: CDN
- Route53: DNS
```

### 12.2 機能拡張
- マイクロサービス化
- GraphQL対応
- WebSocket（リアルタイム通信）
- モバイルアプリ対応

## 13. 技術的制約事項

### 13.1 Replit制約
- メモリ制限: 2GB（Hackerプラン）
- ストレージ: 10GB
- 同時接続数: 制限あり

### 13.2 対応策
- 効率的なメモリ管理
- 定期的なクリーンアップ
- AWS移行の準備

## 14. 参考資料
- FastAPI公式ドキュメント
- React公式ドキュメント
- Atomic Design Methodology
- PostgreSQL Documentation
- Replit Documentation

## 15. 改訂履歴

| 版 | 日付 | 作成者 | 改訂内容 |
|----|------|--------|----------|
| 1.0 | 2025-09-07 | システム設計チーム | 初版作成 |